"""Task-related message handlers"""
import logging
from datetime import datetime, timedelta
from aiogram import Router, F
from aiogram.types import Message

from src.database.database import Database
from src.services.ai import AIService
from src.services.ai.nlp_processor import NLPProcessor

logger = logging.getLogger(__name__)

# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —ç–∫–∑–µ–º–ø–ª—è—Ä—ã —Å–µ—Ä–≤–∏—Å–æ–≤
ai_service: AIService | None = None
nlp_processor: NLPProcessor | None = None

async def handle_text_message(message: Message, db: Database):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∑–∞–¥–∞—á"""
    try:
        if not message.text:
            await message.answer("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –∑–∞–¥–∞—á–∏.")
            return

        processing_msg = await message.answer("ü§î –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Å–æ–æ–±—â–µ–Ω–∏–µ...")

        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–µ—Ä–≤–∏—Å—ã –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏
        global ai_service, nlp_processor
        if ai_service is None:
            ai_service = AIService(db)
        if nlp_processor is None:
            nlp_processor = NLPProcessor()

        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç —á–µ—Ä–µ–∑ NLP
        nlp_result = await nlp_processor.process_message(message.text)
        if not nlp_result:
            await message.answer(
                "‚ùå –ò–∑–≤–∏–Ω–∏—Ç–µ, —è –Ω–µ —Å–º–æ–≥ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ–Ω—è—Ç—å –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.\n"
                "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–ø–∏—Å–∞—Ç—å –∑–∞–¥–∞—á—É –±–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω–æ."
            )
            return

        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∑–∞–¥–∞—á—É —á–µ—Ä–µ–∑ AI —Å–µ—Ä–≤–∏—Å
        task_type = nlp_result.get('task_type', 'general')
        analysis = await ai_service.analyze_plan(message.text, task_type)
        if not analysis:
            await message.answer(
                "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É.\n"
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å."
            )
            return

        # –§–æ—Ä–º–∏—Ä—É–µ–º –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ NLP –∞–Ω–∞–ª–∏–∑–∞
        time_info = nlp_result.get('time_info', {})
        task_time = None

        if time_info.get('explicit_time'):
            # –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –≤—Ä–µ–º—è
            task_time = datetime.combine(
                datetime.now().date(),
                time_info['explicit_time']
            )
        elif time_info.get('relative_time'):
            # –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ–µ –≤—Ä–µ–º—è
            task_time = datetime.now() + time_info['relative_time']
        else:
            # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å—Ç–∞–≤–∏–º –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —á–∞—Å
            task_time = datetime.now().replace(
                minute=0,
                second=0,
                microsecond=0
            ) + timedelta(hours=1)

        # –ü–æ–ª—É—á–∞–µ–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏–∑ –∞–Ω–∞–ª–∏–∑–∞ AI
        duration = int(float(analysis.get('estimated_duration', 1)) * 24 * 60)  # –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –¥–Ω–∏ –≤ –º–∏–Ω—É—Ç—ã
        if time_info.get('duration'):
            duration = time_info['duration']

        # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        response_parts = [
            f"‚úÖ –Ø –ø–æ–Ω—è–ª –≤–∞—à—É –∑–∞–¥–∞—á—É:\n",
            f"üéØ {analysis['title']}",
            f"‚ö°Ô∏è –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: {analysis['priority']}",
            f"‚è∞ –í—Ä–µ–º—è: {task_time.strftime('%H:%M')}",
            f"‚åõÔ∏è –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {duration} –º–∏–Ω—É—Ç\n"
        ]

        if analysis.get('steps'):
            response_parts.append("üìã –®–∞–≥–∏:")
            for i, step in enumerate(analysis['steps'], 1):
                response_parts.append(
                    f"{i}. {step['title']} ({int(float(step['duration']) * 24 * 60)} –º–∏–Ω)"
                )
            response_parts.append("")

        if analysis.get('recommendations'):
            response_parts.append("üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:")
            for rec in analysis['recommendations']:
                response_parts.append(f"  ‚Ä¢ {rec}")
            response_parts.append("")

        if analysis.get('potential_blockers'):
            response_parts.append("‚ö†Ô∏è –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è:")
            for blocker in analysis['potential_blockers']:
                response_parts.append(f"  ‚Ä¢ {blocker}")
            response_parts.append("")

        # –î–æ–±–∞–≤–ª—è–µ–º –æ—Ü–µ–Ω–∫—É —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
        complexity = nlp_result.get('complexity', 5)
        response_parts.append(
            f"üìä –°–ª–æ–∂–Ω–æ—Å—Ç—å: {'üü¶' * ((complexity + 1) // 2)} ({complexity}/10)"
        )

        await processing_msg.delete()
        await message.answer("\n".join(response_parts))

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–¥–∞—á—É –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
        await db.add_task(
            user_id=message.from_user.id,
            text=message.text,
            deadline=task_time,
            priority=analysis['priority'].lower(),
            duration=duration,
            task_type=task_type,
            complexity=complexity
        )

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è: {str(e)}", exc_info=True)
        await message.answer(
            "üö´ –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è.\n"
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
        )

def register_task_handlers(router: Router, db: Database):
    """–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∑–∞–¥–∞—á"""
    router.message.register(
        lambda msg: handle_text_message(msg, db),
        F.text
    )